## 가변 참조의 제한

하지만 가변 참조에는 한 가지 큰 제한이 있습니다: 특정 범위에 특정 데이터에 대해 단 하나의 가변 참조만 가질 수 있습니다. 다음 코드는 실패합니다:

```rust
    let mut s = String::from("hello");

    let r1 = &mut s;
    let r2 = &mut s;

    println!("{}, {}", r1, r2);
```

여기에서 오류가 발생합니다:

```text
    error[E0499]: cannot borrow `s` as mutable more than once at a time
     --> src/main.rs:5:14
      |
    4 |     let r1 = &mut s;
      |              ------ 첫 번째 가변 대여가 여기에서 발생했습니다.
    5 |     let r2 = &mut s;
      |              ^^^^^^ 두 번째 가변 대여가 여기에서 발생했습니다.
    6 |
    7 |     println!("{}, {}", r1, r2);
      |                        -- 첫 번째 대여가 나중에 여기에서 사용되었습니다.
```

이 제한은 변경을 허용하지만 매우 통제된 방식으로만 허용합니다. 이는 Rust 초보자들이 대부분의 언어에서 원하는 대로 변경이 허용되기 때문에 어려움을 겪는 부분입니다.

이 제한의 장점은, Rust가 컴파일 타임에 데이터 경합(data race)을 방지할 수 있다는 점입니다. _데이터 경합_은 경합 조건과 유사하며, 다음 세 가지 동작이 발생할 때 일어납니다:

* 두 개 이상의 포인터가 동시에 동일한 데이터를 액세스합니다.
* 포인터 중 적어도 하나가 데이터를 쓰기 위해 사용됩니다.
* 데이터를 액세스하는 것을 동기화하는 메커니즘이 없습니다.

데이터 경합은 정의되지 않은 동작을 유발하며, 실행 중에 이를 추적하려고 할 때 진단하고 수정하기 어려울 수 있습니다. 하지만 Rust는 데이터 경합이 있는 코드는 아예 컴파일되지 않도록 하여 이 문제를 원천적으로 방지합니다!

언제나 그렇듯이, 중괄호를 사용해 새로운 범위를 생성함으로써 여러 가변 참조를 사용할 수 있지만, _동시_에는 사용할 수 없습니다:

```rust
    let mut s = String::from("hello");

    {
        let r1 = &mut s;

    } // r1은 여기서 범위를 벗어나므로, 문제없이 새로운 참조를 생성할 수 있습니다.

    let r2 = &mut s;
```

가변 참조와 불변 참조를 결합할 때도 유사한 규칙이 적용됩니다. 다음 코드는 오류를 발생시킵니다:

```rust
    let mut s = String::from("hello");

    let r1 = &s; // 문제없음
    let r2 = &s; // 문제없음
    let r3 = &mut s; // 큰 문제 발생

    println!("{}, {}, and {}", r1, r2, r3);
```

여기에서 오류가 발생합니다:

```text
    error[E0502]: cannot borrow `s` as mutable because it is also borrowed as immutable
     --> src/main.rs:6:14
      |
    4 |     let r1 = &s; // 문제없음
      |              -- 불변 대여가 여기에서 발생했습니다.
    5 |     let r2 = &s; // 문제없음
    6 |     let r3 = &mut s; // 큰 문제 발생
      |              ^^^^^^ 가변 대여가 여기에서 발생했습니다.
    7 |
    8 |     println!("{}, {}, and {}", r1, r2, r3);
      |                                -- 불변 대여가 나중에 여기에서 사용되었습니다.
```

휴! 우리는 _가변 참조_를 가질 수 없을 뿐만 아니라 _불변 참조_ 또한 동시에 가질 수 없습니다. 불변 참조를 사용하는 사용자들은 값이 예기치 않게 변경될 거라고 기대하지 않습니다! 하지만 동시에 여러 개의 불변 참조는 괜찮습니다. 데이터를 읽는 것만 하는 사람은 다른 사람이 데이터를 읽는 것에 영향을 줄 수 없기 때문입니다.